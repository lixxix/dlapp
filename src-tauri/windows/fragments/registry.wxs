<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Fragment>
    <DirectoryRef Id="INSTALLDIR">
      <Component Id="MyFragmentRegistryEntries" Guid="*">
        <RegistryKey
          Root="HKCU"
          Key="Software\Classes\dlapp"
          ForceDeleteOnUninstall="yes"
        >
          <RegistryValue
            Type="string"
            Value="URL:dlapp Protocol"
            KeyPath="yes"
          />
          <RegistryValue 
            Type="string" 
            Name="URL Protocol" 
            Value="" 
          />

          <RegistryKey Key="shell\open\command">
            <RegistryValue 
              Type="string" 
              Value="&quot;[INSTALLDIR]dlapp.exe&quot; &quot;%1&quot;"
            />
          </RegistryKey>
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- 自定义操作：安装时发送HTTP请求 -->
    <CustomAction
      Id="SendInstallRequest"
      Directory="INSTALLDIR"
      ExeCommand="&quot;[INSTALLDIR]http-notifier.exe&quot; install"
      Execute="deferred"
      Impersonate="no"
      Return="ignore"
    />

    <!-- 自定义操作：卸载时发送HTTP请求 -->
    <CustomAction
      Id="SendUninstallRequest"
      Directory="INSTALLDIR"
      ExeCommand="&quot;[INSTALLDIR]http-notifier.exe&quot; uninstall"
      Execute="deferred"
      Impersonate="no"
      Return="ignore"
    />

    <!-- 安装序列 -->
    <InstallExecuteSequence>
      <!-- 在安装完成后执行 -->
      <Custom Action="SendInstallRequest" After="InstallFiles">
        NOT Installed AND NOT REMOVE
      </Custom>
      
      <!-- 在卸载之前执行（文件还在） -->
      <Custom Action="SendUninstallRequest" Before="RemoveFiles">
        REMOVE="ALL"
      </Custom>
    </InstallExecuteSequence>

  </Fragment>

</Wix>